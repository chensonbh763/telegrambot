<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>LucreMaisTask</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.adsonar.io/sdk.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    .card, .vip-box, .banner-box {
      background: white;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    h2 {
      color: #2a8f43;
      text-align: center;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: #2a8f43;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1e6e34;
    }
  </style>
</head>
<body>

  <h2>✅ LUCRE MAIS TASK</h2>

  <div class="card">
    <p>📅 Check-in diário: ganhe pontos assistindo anúncio!</p>
    <button onclick="checkin()">🎁 Fazer check-in</button>
  </div>

  <div class="vip-box">
    <strong>🎯 Torne-se VIP!</strong><br>
    Ganhe <b>% da pontuação</b> de todos que usam esse bot.<br><br>
    <a href="https://www.mfuture.com.br/lucremais/prevenda.html" target="_blank">
      <button>🚀 Quero ser VIP</button>
    </a>
  </div>

  <div class="card">
    <h3>📋 Tarefas do Dia</h3>
    <div id="tarefas">🔄 Carregando tarefas...</div>
  </div>

  <div class="banner-box">
    <h4>📢 Anúncio</h4>
    <div id="meu_banner"></div>
  </div>

  <script>
    const telegram_id = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || new URLSearchParams(location.search).get("id");

    if (!telegram_id) {
      document.getElementById("tarefas").innerHTML = "❌ ID do Telegram não encontrado.";
    }

    // Mostrar banner
    window.Sonar?.show?.({
      adUnit: "meu_banner",
      onShow: () => console.log("📢 Banner exibido"),
      onError: () => console.warn("❌ Erro ao exibir banner")
    });

    function gerarIdNumerico(prefixo = "") {
      const date = new Date().toISOString().slice(0,10).replace(/-/g,"");
      return parseInt(date); // retorna um número como 20250725
    }

    function checkin() {
      if (!telegram_id) return alert("⚠️ ID Telegram não encontrado.");
      const tarefa_id = gerarIdNumerico("checkin");
      window.Sonar?.show({
        adUnit: "checkin_diario",
        loader: true,
        onReward: async () => {
          const res = await fetch("/api/concluir-tarefa", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ telegram_id, tarefa_id, pontos: 1 })
          });

          const data = await res.json();
          alert(data.mensagem || data.erro || "⚠️ Erro desconhecido.");
        },
        onError: () => alert("❌ Erro ao carregar anúncio."),
        onClose: () => console.log("Anúncio fechado")
      });
    }

    async function carregarTarefas() {
      try {
        const res = await fetch("/api/tarefas");
        const tarefas = await res.json();
        const div = document.getElementById("tarefas");
        div.innerHTML = "";

        if (tarefas.length === 0) {
          div.innerHTML = "🎉 Nenhuma tarefa disponível no momento.";
          return;
        }

        tarefas.forEach(t => {
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <strong>${t.titulo}</strong><br>
            Pontos: ${t.pontos}<br>
            <button onclick="concluirTarefa(${t.id}, ${t.pontos}, '${encodeURIComponent(t.link)}')">📺 Assistir anúncio</button>
          `;
          div.appendChild(el);
        });

      } catch (err) {
        console.error("Erro ao carregar tarefas:", err);
        document.getElementById("tarefas").innerText = "❌ Erro ao carregar tarefas.";
      }
    }

    function concluirTarefa(tarefa_id, pontos, link) {
      if (!telegram_id) return alert("⚠️ ID não encontrado.");

      window.Sonar?.show?.({
        adUnit: "checkin_diario",
        onReward: async () => {
          const res = await fetch("/api/concluir-tarefa", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ telegram_id, tarefa_id, pontos })
          });
          const data = await res.json();
          alert(data.mensagem || data.erro || "⚠️ Erro ao concluir.");
          window.open(decodeURIComponent(link), "_blank");
        },
        onError: () => alert("❌ Anúncio falhou."),
      });
    }

    if (telegram_id) carregarTarefas();
  </script>
</body>
</html>
