
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>LucreMaisTask - Minhas Tarefas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="//libtl.com/sdk.js" data-zone="9579151" data-sdk="show_9579151"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #f9f9f9;
    }
    h2, h3 { color: #2a8f43; }
    .box { background: #fff; border: 1px solid #ccc; padding: 15px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    button {
      padding: 10px 16px;
      font-size: 1rem;
      background-color: #2a8f43;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background-color: #237539; }
  </style>
</head>
<body>

  <h2>✅ Minhas Tarefas</h2>
  <div id="status" class="box">Carregando informações...</div>
  <div id="tarefas">Carregando tarefas...</div>

<script>
  const telegram = window.Telegram.WebApp;
  telegram.expand();
  const userId = telegram.initDataUnsafe.user?.id || "desconhecido";

  async function carregarStatus() {
    const res = await fetch("/api/status/" + userId);
    const dados = await res.json();

    const refLink = "https://t.me/LucreMaisTask_bot?start=" + userId;
    const div = document.getElementById("status");
    div.innerHTML = `
      <strong>👤 Nome:</strong> ${dados.nome || "Visitante"}<br>
      <strong>💰 Pontos:</strong> ${dados.pontos}<br>
      <strong>👥 Indicações:</strong> ${dados.indicacoes}<br>
      <strong>💎 VIP:</strong> ${dados.vip ? "Sim" : "Não"}<br><br>
      <button onclick="window.open('${refLink}', '_blank')">📤 Compartilhar link</button>
      ${!dados.vip ? '<button onclick="window.open('https://mfuture.com.br/lucremais/vip', '_blank')">💎 Tornar-se VIP</button>' : ''}
    `;
  }

  async function carregarTarefas() {
    const res = await fetch("/api/tarefas");
    const tarefas = await res.json();
    const container = document.getElementById("tarefas");
    container.innerHTML = "";

    if (tarefas.length === 0) {
      container.innerHTML = "<p>🎉 Nenhuma tarefa disponível agora. Volte mais tarde!</p>";
      return;
    }

    tarefas.forEach(t => {
      const el = document.createElement("div");
      el.className = "box";
      el.innerHTML = `
        <strong>${t.titulo}</strong><br>
        Pontos: ${t.pontos}<br>
        <button onclick="verAnuncio('${t.link}', ${t.id})">🎥 Ver anúncio e abrir</button>
      `;
      container.appendChild(el);
    });
  }

  function verAnuncio(link, tarefaId) {
    show_9579151().then(() => {
      fetch("/api/concluir", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegram_id: userId, tarefa_id: tarefaId })
      });
      window.open(link, "_blank");
    }).catch(() => {
      alert("⚠️ Anúncio não pôde ser exibido.");
    });
  }

  carregarStatus();
  carregarTarefas();
</script>

</body>
</html>
