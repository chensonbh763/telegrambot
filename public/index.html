<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>LucreMais - Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>body{font-family:sans-serif;padding:1em}</style>
</head>
<body>
  <h2>Bem-vindo ao LucreMais ðŸ’¸</h2>
  <div id="status">Carregando dados...</div>
  <ul id="tarefas"></ul>

  <div style="margin-top: 20px;">
    <p>ðŸ“£ Convide amigos e ganhe pontos:</p>
    <input type="text" id="link" style="width: 100%;" readonly />
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || 0;
    const api = "/api";

    async function carregarStatus() {
      const r = await fetch(`${api}/status/${userId}`);
      const data = await r.json();
      document.getElementById("status").innerHTML =
        `ðŸ‘¤ ${data.nome} | â­ VIP: ${data.vip ? 'SIM' : 'NÃƒO'} | ðŸ’° Pontos: ${data.pontos}`;

      document.getElementById("link").value =
        `https://t.me/LucreMaisTask_bot?start=${userId}`;
    }

    async function carregarTarefas() {
      const r = await fetch(`${api}/tarefas`);
      const tarefas = await r.json();
      const lista = document.getElementById("tarefas");
      tarefas.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `
          âœ… ${t.titulo} 
          <button onclick="concluir(${t.id}, '${t.link}')">Fazer</button>
        `;
        lista.appendChild(li);
      });
    }

    async function concluir(id, link) {
      await fetch(`${api}/concluir`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegram_id: userId, tarefa_id: id })
      });
      window.open(link, "_blank");
      alert("Tarefa registrada! âœ…");
    }

    carregarStatus();
    carregarTarefas();
  </script>
</body>
</html>
