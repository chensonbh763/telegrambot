<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>LucreMais - Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>body{font-family:sans-serif;padding:1em}</style>
</head>
<body>
  <h2>Bem-vindo ao LucreMais 💸</h2>
  <div id="status">Carregando dados...</div>
  <ul id="tarefas"></ul>

  <div style="margin-top: 20px;">
    <p>📣 Convide amigos e ganhe pontos:</p>
    <input type="text" id="link" style="width: 100%;" readonly />
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || 0;
    const api = "/api";

    async function carregarStatus() {
      const r = await fetch(`${api}/status/${userId}`);
      const data = await r.json();
      document.getElementById("status").innerHTML =
        `👤 ${data.nome} | ⭐ VIP: ${data.vip ? 'SIM' : 'NÃO'} | 💰 Pontos: ${data.pontos}`;

      document.getElementById("link").value =
        `https://t.me/LucreMaisTask_bot?start=${userId}`;
    }

    async function carregarTarefas() {
      const r = await fetch(`${api}/tarefas`);
      const tarefas = await r.json();
      const lista = document.getElementById("tarefas");
      tarefas.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `
          ✅ ${t.titulo} 
          <button onclick="concluir(${t.id}, '${t.link}')">Fazer</button>
        `;
        lista.appendChild(li);
      });
    }

    async function concluir(id, link) {
      await fetch(`${api}/concluir`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegram_id: userId, tarefa_id: id })
      });
      window.open(link, "_blank");
      alert("Tarefa registrada! ✅");
    }

    carregarStatus();
    carregarTarefas();

    async function carregarConexao() {
  const res = await fetch("/api/conexao");
  const db = await res.json();
  const info = `
    🧠 Banco: ${db.database}  
    🔗 Host: ${db.host}  
    👤 Usuário: ${db.user}  
    🌐 Porta: ${db.port}
  `;
  const status = document.getElementById("status");
  status.innerHTML += `<br/><br/><strong>🔍 Conexão:</strong><br/>${info}`;
}

carregarConexao();
  </script>
</body>
</html>
